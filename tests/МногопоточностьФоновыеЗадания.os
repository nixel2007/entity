// BSLLS:MagicNumber-off
// BSLLS:LatinAndCyrillicSymbolInWord-off
// BSLLS:DuplicateStringLiteral-off
// BSLLS:LineLength-off

#Использовать ".."
#Использовать "utils"

Перем МенеджерСущностей;
Перем СтрокаСоединенияКоннектора; // Для использования в тестах с пулом соединений

Процедура ПередЗапускомТеста() Экспорт

	ЗапускатьТестыPostgres = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("TESTRUNNER_RUN_POSTGRES_TESTS", "true");
	ЗапускатьТестыSQLite = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("TESTRUNNER_RUN_SQLITE_TESTS", "true");

	ВыполнятьСбросТаблиц = Ложь;
	Если ЗапускатьТестыSQLite = "true" Тогда
		СтрокаСоединения = "FullUri=file::memory:?cache=shared";
		//СтрокаСоединения = "Data Source=test.db";
		ТипКоннектора = Тип("КоннекторSQLite");
	ИначеЕсли ЗапускатьТестыPostgres = "true" Тогда
		Хост = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("POSTGRES_HOST", "localhost");
		Порт = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("POSTGRES_PORT", "5432");
		Пользователь = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("POSTGRES_USERNAME", "postgres");
		Пароль = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("POSTGRES_PASSWORD", "postgres");
		ИмяБД = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("POSTGRES_DATABASE", "postgres");
		СтрокаСоединения = СтрШаблон(
			"Host=%1;Username=%2;Password=%3;Database=%4;port=%5;",
			Хост,
			Пользователь,
			Пароль,
			ИмяБД,
			Порт
		);
		ТипКоннектора = Тип("КоннекторPostgreSQL");
		ВыполнятьСбросТаблиц = Истина;
	Иначе
		ВызватьИсключение "Нет доступного коннектора для тестирования менеджера сущностей";
	КонецЕсли;
	
	// Сохраняем строку соединения для использования в тестах с пулом
	СтрокаСоединенияКоннектора = СтрокаСоединения;
	
	МенеджерСущностей = Новый МенеджерСущностей(ТипКоннектора, СтрокаСоединения);
	
	Если ВыполнятьСбросТаблиц Тогда
		Коннектор = МенеджерСущностей.ПолучитьКоннектор();
		Коннектор.Открыть(СтрокаСоединения, Новый Массив);
		ТестовыеУтилиты.УдалитьТаблицыВБазеДанных(Коннектор);
		Коннектор.Закрыть();
	КонецЕсли;

	ПодключитьСценарий(
		ОбъединитьПути(
			ТекущийКаталог(), 
			"tests", 
			"fixtures", 
			"Автор.os"
		), 
		"Автор"
	);
	ПодключитьСценарий(
		ОбъединитьПути(
			ТекущийКаталог(), 
			"tests", 
			"fixtures", 
			"СущностьБезГенерируемогоИдентификатора.os"
		), 
		"СущностьБезГенерируемогоИдентификатора"
	);
	ПодключитьСценарий(
		ОбъединитьПути(
			ТекущийКаталог(), 
			"tests", 
			"fixtures", 
			"СущностьСоВсемиТипамиКолонок.os"
		), 
		"СущностьСоВсемиТипамиКолонок"
	);
	
	МенеджерСущностей.ДобавитьКлассВМодель(Тип("СущностьБезГенерируемогоИдентификатора"));
	МенеджерСущностей.ДобавитьКлассВМодель(Тип("Автор"));
	МенеджерСущностей.ДобавитьКлассВМодель(Тип("СущностьСоВсемиТипамиКолонок"));
	
	МенеджерСущностей.Инициализировать();

КонецПроцедуры

Процедура ПослеЗапускаТеста() Экспорт
	МенеджерСущностей.Закрыть();
	МенеджерСущностей = Неопределено;
КонецПроцедуры

&Тест
Процедура НезависимыеТранзакцииВРазныхКонтекстах() Экспорт
	// Проверяем, что транзакции в разных контекстах не влияют друг на друга
	
	// Контекст 1 - имитирует основной поток
	КонтекстID1 = МенеджерСущностей.НачатьТранзакцию();
	Ожидаем.Что(КонтекстID1, "Контекст 1 должен быть создан").Не_().Равно(Неопределено);
	
	// Сохраняем сущность в контексте 1
	Автор1 = Новый Автор;
	Автор1.Имя = "Первый";
	Автор1.ВтороеИмя = "Автор";
	МенеджерСущностей.Сохранить(Автор1, КонтекстID1);
	
	// Контекст 2 - имитирует фоновое задание
	КонтекстID2 = МенеджерСущностей.НачатьТранзакцию();
	Ожидаем.Что(КонтекстID2, "Контекст 2 должен быть создан").Не_().Равно(Неопределено);
	Ожидаем.Что(КонтекстID2, "Контексты должны быть разными").Не_().Равно(КонтекстID1);
	
	// Сохраняем другую сущность в контексте 2
	Автор2 = Новый Автор;
	Автор2.Имя = "Второй";
	Автор2.ВтороеИмя = "Автор";
	МенеджерСущностей.Сохранить(Автор2, КонтекстID2);
	
	// Откатываем только контекст 2 (имитируем ошибку в фоновом задании)
	МенеджерСущностей.ОтменитьТранзакцию(КонтекстID2);
	
	// Фиксируем контекст 1 (основной поток завершается успешно)
	МенеджерСущностей.ЗафиксироватьТранзакцию(КонтекстID1);
	
	// Проверяем результат - должен остаться только автор из контекста 1
	Результат = МенеджерСущностей.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы");
	Ожидаем.Что(Результат, "Должен остаться только один автор").ИмеетДлину(1);
	Ожидаем.Что(Результат[0].Имя, "Должен остаться автор из первого контекста").Равно("Первый");
КонецПроцедуры

&Тест
Процедура МногократныеНезависимыеТранзакции() Экспорт
	// Проверяем работу нескольких независимых транзакций подряд
	
	МассивКонтекстов = Новый Массив;
	
	// Создаем несколько контекстов (имитируем множественные фоновые задания)
	Для Индекс = 1 По 3 Цикл
		КонтекстID = МенеджерСущностей.НачатьТранзакцию();
		МассивКонтекстов.Добавить(КонтекстID);
		
		// В каждом контексте сохраняем автора
		Автор = Новый Автор;
		Автор.Имя = "Автор" + Индекс;
		Автор.ВтороеИмя = "Контекст" + Индекс;
		МенеджерСущностей.Сохранить(Автор, КонтекстID);
	КонецЦикла;
	
	// Фиксируем все транзакции
	Для Каждого КонтекстID Из МассивКонтекстов Цикл
		МенеджерСущностей.ЗафиксироватьТранзакцию(КонтекстID);
	КонецЦикла;
	
	// Проверяем, что все авторы сохранились
	Результат = МенеджерСущностей.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы ORDER BY Имя");
	Ожидаем.Что(Результат, "Должны сохраниться все три автора").ИмеетДлину(3);
	
	Для Индекс = 0 По 2 Цикл
		ОжидаемоеИмя = "Автор" + (Индекс + 1);
		Ожидаем.Что(Результат[Индекс].Имя, "Автор должен быть сохранен корректно").Равно(ОжидаемоеИмя);
	КонецЦикла;
КонецПроцедуры

&Тест
Процедура ОбратнаяСовместимостьБезКонтекстов() Экспорт
	// Проверяем, что старый API без указания контекстов продолжает работать
	
	МенеджерСущностей.НачатьТранзакцию(); // Без возврата КонтекстID
	
	Автор = Новый Автор;
	Автор.Имя = "Старый";
	Автор.ВтороеИмя = "API";
	МенеджерСущностей.Сохранить(Автор); // Без указания контекста
	
	МенеджерСущностей.ЗафиксироватьТранзакцию(); // Без указания контекста
	
	// Проверяем результат
	Результат = МенеджерСущностей.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы");
	Ожидаем.Что(Результат, "Автор должен быть сохранен").ИмеетДлину(1);
	Ожидаем.Что(Результат[0].Имя, "Имя автора должно быть корректным").Равно("Старый");
КонецПроцедуры

&Тест
Процедура СмешанноеИспользованиеКонтекстовИБезКонтекстов() Экспорт
	// Проверяем совместимость нового и старого API
	
	// Новый API с контекстом
	КонтекстID = МенеджерСущностей.НачатьТранзакцию();
	
	Автор1 = Новый Автор;
	Автор1.Имя = "Новый";
	Автор1.ВтороеИмя = "API";
	МенеджерСущностей.Сохранить(Автор1, КонтекстID);
	
	// Старый API без контекста (параллельно)
	МенеджерСущностей.НачатьТранзакцию();
	
	Автор2 = Новый Автор;
	Автор2.Имя = "Старый";
	Автор2.ВтороеИмя = "API";
	МенеджерСущностей.Сохранить(Автор2);
	
	// Фиксируем обе транзакции
	МенеджерСущностей.ЗафиксироватьТранзакцию(КонтекстID);
	МенеджерСущностей.ЗафиксироватьТранзакцию();
	
	// Проверяем результат
	Результат = МенеджерСущностей.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы ORDER BY Имя");
	Ожидаем.Что(Результат, "Должны быть сохранены оба автора").ИмеетДлину(2);
	Ожидаем.Что(Результат[0].Имя, "Первый автор").Равно("Новый");
	Ожидаем.Что(Результат[1].Имя, "Второй автор").Равно("Старый");
КонецПроцедуры

&Тест
Процедура СимуляцияФоновогоЗаданияСОшибкой() Экспорт
	// Имитируем ситуацию, когда фоновое задание завершается с ошибкой
	
	// Основной поток начинает транзакцию
	ОсновнойКонтекстID = МенеджерСущностей.НачатьТранзакцию();
	
	Автор1 = Новый Автор;
	Автор1.Имя = "Основной";
	Автор1.ВтороеИмя = "Поток";
	МенеджерСущностей.Сохранить(Автор1, ОсновнойКонтекстID);
	
	// Фоновое задание начинает свою транзакцию
	ФоновыйКонтекстID = МенеджерСущностей.НачатьТранзакцию();
	
	Автор2 = Новый Автор;
	Автор2.Имя = "Фоновое";
	Автор2.ВтороеИмя = "Задание";
	МенеджерСущностей.Сохранить(Автор2, ФоновыйКонтекстID);
	
	// Основной поток завершается успешно
	МенеджерСущностей.ЗафиксироватьТранзакцию(ОсновнойКонтекстID);
	
	// Фоновое задание завершается с ошибкой (откат)
	МенеджерСущностей.ОтменитьТранзакцию(ФоновыйКонтекстID);
	
	// Проверяем, что сохранился только автор из основного потока
	Результат = МенеджерСущностей.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы");
	Ожидаем.Что(Результат, "Должен остаться только автор из основного потока").ИмеетДлину(1);
	Ожидаем.Что(Результат[0].Имя, "Должен остаться правильный автор").Равно("Основной");
КонецПроцедуры

// Тест для демонстрации реальной работы с ФоновыеЗадания API  
// Проверяет многопоточную работу менеджера сущностей в режиме фоновых заданий
&Тест
Процедура МногопоточнаяРаботаСФоновымиЗаданиями() Экспорт
	// Проверяем доступность API фоновых заданий
	
	ДоступныФоновыеЗадания = Ложь;
	Попытка
		Если ТипЗнч(ФоновыеЗадания) = Тип("МенеджерФоновыхЗаданий") Тогда
			ДоступныФоновыеЗадания = Истина;
		КонецЕсли;
	Исключение
		// API фоновых заданий недоступен
	КонецПопытки;
	
	Если НЕ ДоступныФоновыеЗадания Тогда
		Сообщить("API фоновых заданий недоступен. Выполняем симуляцию многопоточности.");
		ВыполнитьСимуляциюМногопоточности();
		Возврат;
	КонецЕсли;
	
	// Создаем менеджер с пулом соединений для тестирования
	ТипКоннекторы = ТипЗнч(МенеджерСущностей.ПолучитьКоннектор());
	МенеджерСПулом = Новый МенеджерСущностей(
		ТипКоннекторы, 
		СтрокаСоединенияКоннектора, // Используем сохраненную строку соединения из ПередЗапускомТеста
		Неопределено,
		3 // Пул из 3 соединений
	);
	МенеджерСПулом.ДобавитьКлассВМодель(Тип("Автор"));
	МенеджерСПулом.Инициализировать();
	
	// Начинаем транзакцию в основном потоке
	ОсновнойКонтекстID = МенеджерСПулом.НачатьТранзакцию();
	
	Автор1 = Новый Автор;
	Автор1.Имя = "Основной";
	Автор1.ВтороеИмя = "Поток";
	МенеджерСПулом.Сохранить(Автор1, ОсновнойКонтекстID);
	
	// Запускаем несколько фоновых заданий параллельно
	МассивЗаданий = Новый Массив;
	
	Для Индекс = 1 По 2 Цикл
		ПараметрыЗадания = Новый Структура;
		ПараметрыЗадания.Вставить("МенеджерСущностей", МенеджерСПулом);
		ПараметрыЗадания.Вставить("НомерЗадания", Индекс);
		
		ФоновоеЗадание = ФоновыеЗадания.Выполнить("ФоновоеЗаданиеСозданияАвтораСПулом", ПараметрыЗадания);
		МассивЗаданий.Добавить(ФоновоеЗадание);
	КонецЦикла;
	
	// Ждем завершения всех фоновых заданий (максимум 10 секунд)
	СчетчикОжидания = 0;
	Пока СчетчикОжидания < 100 Цикл
		ВсеЗавершены = Истина;
		Для Каждого Задание Из МассивЗаданий Цикл
			Если Задание.Состояние = СостояниеФоновогоЗадания.Активно Тогда
				ВсеЗавершены = Ложь;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если ВсеЗавершены Тогда
			Прервать;
		КонецЕсли;
		
		Приостановить(100); // 100 мс
		СчетчикОжидания = СчетчикОжидания + 1;
	КонецЦикла;
	
	// Фиксируем транзакцию основного потока
	МенеджерСПулом.ЗафиксироватьТранзакцию(ОсновнойКонтекстID);
	
	// Проверяем результат
	Результат = МенеджерСПулом.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы ORDER BY Имя");
	
	// Подсчитываем успешно завершенные задания
	КоличествоУспешныхЗаданий = 0;
	Для Каждого Задание Из МассивЗаданий Цикл
		Если Задание.Состояние = СостояниеФоновогоЗадания.Завершено Тогда
			КоличествоУспешныхЗаданий = КоличествоУспешныхЗаданий + 1;
		КонецЕсли;
	КонецЦикла;
	
	ОжидаемоеКоличествоАвторов = 1 + КоличествоУспешныхЗаданий; // Основной поток + успешные задания
	Ожидаем.Что(Результат, "Количество авторов должно соответствовать успешно завершенным операциям").ИмеетДлину(ОжидаемоеКоличествоАвторов);
	
	// Проверяем, что автор из основного потока точно есть
	НайденОсновнойАвтор = Ложь;
	Для Каждого Строка Из Результат Цикл
		Если Строка.Имя = "Основной" Тогда
			НайденОсновнойАвтор = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	Ожидаем.Что(НайденОсновнойАвтор, "Автор из основного потока должен быть сохранен").ЭтоИстина();
	
	МенеджерСПулом.Закрыть();
КонецПроцедуры

// Симуляция многопоточности когда API фоновых заданий недоступен
Процедура ВыполнитьСимуляциюМногопоточности()
	// Создаем несколько независимых контекстов для имитации многопоточности
	ТипКоннекторы = ТипЗнч(МенеджерСущностей.ПолучитьКоннектор());
	МенеджерСПулом = Новый МенеджерСущностей(
		ТипКоннекторы, 
		СтрокаСоединенияКоннектора,
		Неопределено,
		3
	);
	МенеджерСПулом.ДобавитьКлассВМодель(Тип("Автор"));
	МенеджерСПулом.Инициализировать();
	
	// Имитируем параллельную работу нескольких "потоков"
	МассивКонтекстов = Новый Массив;
	
	// "Поток" 1
	КонтекстID1 = МенеджерСПулом.НачатьТранзакцию();
	МассивКонтекстов.Добавить(КонтекстID1);
	
	Автор1 = Новый Автор;
	Автор1.Имя = "Поток1";
	Автор1.ВтороеИмя = "Симуляция";
	МенеджерСПулом.Сохранить(Автор1, КонтекстID1);
	
	// "Поток" 2 
	КонтекстID2 = МенеджерСПулом.НачатьТранзакцию();
	МассивКонтекстов.Добавить(КонтекстID2);
	
	Автор2 = Новый Автор;
	Автор2.Имя = "Поток2";
	Автор2.ВтороеИмя = "Симуляция";
	МенеджерСПулом.Сохранить(Автор2, КонтекстID2);
	
	// "Поток" 3 с ошибкой
	КонтекстID3 = МенеджерСПулом.НачатьТранзакцию();
	МассивКонтекстов.Добавить(КонтекстID3);
	
	Автор3 = Новый Автор;
	Автор3.Имя = "Поток3";
	Автор3.ВтороеИмя = "СОшибкой";
	МенеджерСПулом.Сохранить(Автор3, КонтекстID3);
	
	// Фиксируем первые два, третий откатываем
	МенеджерСПулом.ЗафиксироватьТранзакцию(КонтекстID1);
	МенеджерСПулом.ЗафиксироватьТранзакцию(КонтекстID2);
	МенеджерСПулом.ОтменитьТранзакцию(КонтекстID3); // Имитируем ошибку
	
	// Проверяем результат
	Результат = МенеджерСПулом.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы ORDER BY Имя");
	Ожидаем.Что(Результат, "Должны сохраниться только успешные операции").ИмеетДлину(2);
	Ожидаем.Что(Результат[0].Имя, "Первый автор").Равно("Поток1");
	Ожидаем.Что(Результат[1].Имя, "Второй автор").Равно("Поток2");
	
	МенеджерСПулом.Закрыть();
КонецПроцедуры

// Процедура для выполнения в фоновом задании
Процедура ФоновоеЗаданиеСозданияАвтора(ПараметрыЗадания) Экспорт
	МенеджерСущностей = ПараметрыЗадания.МенеджерСущностей;
	
	// Начинаем транзакцию в фоновом задании
	КонтекстID = МенеджерСущностей.НачатьТранзакцию();
	
	Попытка
		Автор = Новый Автор;
		Автор.Имя = "Фоновое";
		Автор.ВтороеИмя = "Задание";
		МенеджерСущностей.Сохранить(Автор, КонтекстID);
		
		// Фиксируем транзакцию
		МенеджерСущностей.ЗафиксироватьТранзакцию(КонтекстID);
	Исключение
		// В случае ошибки откатываем транзакцию
		МенеджерСущностей.ОтменитьТранзакцию(КонтекстID);
		ВызватьИсключение;
	КонецПопытки;
КонецПроцедуры

// Процедура для выполнения в фоновом задании с пулом соединений
Процедура ФоновоеЗаданиеСозданияАвтораСПулом(ПараметрыЗадания) Экспорт
	МенеджерСущностей = ПараметрыЗадания.МенеджерСущностей;
	НомерЗадания = ПараметрыЗадания.НомерЗадания;
	
	// Начинаем транзакцию в фоновом задании
	КонтекстID = МенеджерСущностей.НачатьТранзакцию();
	
	Попытка
		Автор = Новый Автор;
		Автор.Имя = "Фоновое" + НомерЗадания;
		Автор.ВтороеИмя = "Задание";
		МенеджерСущностей.Сохранить(Автор, КонтекстID);
		
		// Имитируем некоторую работу
		Приостановить(10 + НомерЗадания * 5); // Разные времена выполнения
		
		// Фиксируем транзакцию
		МенеджерСущностей.ЗафиксироватьТранзакцию(КонтекстID);
	Исключение
		// В случае ошибки откатываем транзакцию
		МенеджерСущностей.ОтменитьТранзакцию(КонтекстID);
		ВызватьИсключение;
	КонецПопытки;
КонецПроцедуры