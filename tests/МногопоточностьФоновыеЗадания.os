// BSLLS:MagicNumber-off
// BSLLS:LatinAndCyrillicSymbolInWord-off
// BSLLS:DuplicateStringLiteral-off
// BSLLS:LineLength-off

#Использовать ".."
#Использовать "utils"

Перем МенеджерСущностей;

Процедура ПередЗапускомТеста() Экспорт

	ЗапускатьТестыPostgres = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("TESTRUNNER_RUN_POSTGRES_TESTS", "true");
	ЗапускатьТестыSQLite = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("TESTRUNNER_RUN_SQLITE_TESTS", "true");

	ВыполнятьСбросТаблиц = Ложь;
	Если ЗапускатьТестыSQLite = "true" Тогда
		СтрокаСоединения = "FullUri=file::memory:?cache=shared";
		//СтрокаСоединения = "Data Source=test.db";
		ТипКоннектора = Тип("КоннекторSQLite");
	ИначеЕсли ЗапускатьТестыPostgres = "true" Тогда
		Хост = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("POSTGRES_HOST", "localhost");
		Порт = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("POSTGRES_PORT", "5432");
		Пользователь = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("POSTGRES_USERNAME", "postgres");
		Пароль = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("POSTGRES_PASSWORD", "postgres");
		ИмяБД = ТестовыеУтилиты.ПолучитьПеременнуюСредыИлиЗначение("POSTGRES_DATABASE", "postgres");
		СтрокаСоединения = СтрШаблон(
			"Host=%1;Username=%2;Password=%3;Database=%4;port=%5;",
			Хост,
			Пользователь,
			Пароль,
			ИмяБД,
			Порт
		);
		ТипКоннектора = Тип("КоннекторPostgreSQL");
		ВыполнятьСбросТаблиц = Истина;
	Иначе
		ВызватьИсключение "Нет доступного коннектора для тестирования менеджера сущностей";
	КонецЕсли;
	
	МенеджерСущностей = Новый МенеджерСущностей(ТипКоннектора, СтрокаСоединения);
	
	Если ВыполнятьСбросТаблиц Тогда
		Коннектор = МенеджерСущностей.ПолучитьКоннектор();
		Коннектор.Открыть(СтрокаСоединения, Новый Массив);
		ТестовыеУтилиты.УдалитьТаблицыВБазеДанных(Коннектор);
		Коннектор.Закрыть();
	КонецЕсли;

	ПодключитьСценарий(
		ОбъединитьПути(
			ТекущийКаталог(), 
			"tests", 
			"fixtures", 
			"Автор.os"
		), 
		"Автор"
	);
	ПодключитьСценарий(
		ОбъединитьПути(
			ТекущийКаталог(), 
			"tests", 
			"fixtures", 
			"СущностьБезГенерируемогоИдентификатора.os"
		), 
		"СущностьБезГенерируемогоИдентификатора"
	);
	ПодключитьСценарий(
		ОбъединитьПути(
			ТекущийКаталог(), 
			"tests", 
			"fixtures", 
			"СущностьСоВсемиТипамиКолонок.os"
		), 
		"СущностьСоВсемиТипамиКолонок"
	);
	
	МенеджерСущностей.ДобавитьКлассВМодель(Тип("СущностьБезГенерируемогоИдентификатора"));
	МенеджерСущностей.ДобавитьКлассВМодель(Тип("Автор"));
	МенеджерСущностей.ДобавитьКлассВМодель(Тип("СущностьСоВсемиТипамиКолонок"));
	
	МенеджерСущностей.Инициализировать();

КонецПроцедуры

Процедура ПослеЗапускаТеста() Экспорт
	МенеджерСущностей.Закрыть();
	МенеджерСущностей = Неопределено;
КонецПроцедуры

&Тест
Процедура НезависимыеТранзакцииВРазныхКонтекстах() Экспорт
	// Проверяем, что транзакции в разных контекстах не влияют друг на друга
	
	// Контекст 1 - имитирует основной поток
	КонтекстID1 = МенеджерСущностей.НачатьТранзакцию();
	Ожидаем.Что(КонтекстID1, "Контекст 1 должен быть создан").Не_().Равно(Неопределено);
	
	// Сохраняем сущность в контексте 1
	Автор1 = Новый Автор;
	Автор1.Имя = "Первый";
	Автор1.ВтороеИмя = "Автор";
	МенеджерСущностей.Сохранить(Автор1, КонтекстID1);
	
	// Контекст 2 - имитирует фоновое задание
	КонтекстID2 = МенеджерСущностей.НачатьТранзакцию();
	Ожидаем.Что(КонтекстID2, "Контекст 2 должен быть создан").Не_().Равно(Неопределено);
	Ожидаем.Что(КонтекстID2, "Контексты должны быть разными").Не_().Равно(КонтекстID1);
	
	// Сохраняем другую сущность в контексте 2
	Автор2 = Новый Автор;
	Автор2.Имя = "Второй";
	Автор2.ВтороеИмя = "Автор";
	МенеджерСущностей.Сохранить(Автор2, КонтекстID2);
	
	// Откатываем только контекст 2 (имитируем ошибку в фоновом задании)
	МенеджерСущностей.ОтменитьТранзакцию(КонтекстID2);
	
	// Фиксируем контекст 1 (основной поток завершается успешно)
	МенеджерСущностей.ЗафиксироватьТранзакцию(КонтекстID1);
	
	// Проверяем результат - должен остаться только автор из контекста 1
	Результат = МенеджерСущностей.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы");
	Ожидаем.Что(Результат, "Должен остаться только один автор").ИмеетДлину(1);
	Ожидаем.Что(Результат[0].Имя, "Должен остаться автор из первого контекста").Равно("Первый");
КонецПроцедуры

&Тест
Процедура МногократныеНезависимыеТранзакции() Экспорт
	// Проверяем работу нескольких независимых транзакций подряд
	
	МассивКонтекстов = Новый Массив;
	
	// Создаем несколько контекстов (имитируем множественные фоновые задания)
	Для Индекс = 1 По 3 Цикл
		КонтекстID = МенеджерСущностей.НачатьТранзакцию();
		МассивКонтекстов.Добавить(КонтекстID);
		
		// В каждом контексте сохраняем автора
		Автор = Новый Автор;
		Автор.Имя = "Автор" + Индекс;
		Автор.ВтороеИмя = "Контекст" + Индекс;
		МенеджерСущностей.Сохранить(Автор, КонтекстID);
	КонецЦикла;
	
	// Фиксируем все транзакции
	Для Каждого КонтекстID Из МассивКонтекстов Цикл
		МенеджерСущностей.ЗафиксироватьТранзакцию(КонтекстID);
	КонецЦикла;
	
	// Проверяем, что все авторы сохранились
	Результат = МенеджерСущностей.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы ORDER BY Имя");
	Ожидаем.Что(Результат, "Должны сохраниться все три автора").ИмеетДлину(3);
	
	Для Индекс = 0 По 2 Цикл
		ОжидаемоеИмя = "Автор" + (Индекс + 1);
		Ожидаем.Что(Результат[Индекс].Имя, "Автор должен быть сохранен корректно").Равно(ОжидаемоеИмя);
	КонецЦикла;
КонецПроцедуры

&Тест
Процедура ОбратнаяСовместимостьБезКонтекстов() Экспорт
	// Проверяем, что старый API без указания контекстов продолжает работать
	
	МенеджерСущностей.НачатьТранзакцию(); // Без возврата КонтекстID
	
	Автор = Новый Автор;
	Автор.Имя = "Старый";
	Автор.ВтороеИмя = "API";
	МенеджерСущностей.Сохранить(Автор); // Без указания контекста
	
	МенеджерСущностей.ЗафиксироватьТранзакцию(); // Без указания контекста
	
	// Проверяем результат
	Результат = МенеджерСущностей.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы");
	Ожидаем.Что(Результат, "Автор должен быть сохранен").ИмеетДлину(1);
	Ожидаем.Что(Результат[0].Имя, "Имя автора должно быть корректным").Равно("Старый");
КонецПроцедуры

&Тест
Процедура СмешанноеИспользованиеКонтекстовИБезКонтекстов() Экспорт
	// Проверяем совместимость нового и старого API
	
	// Новый API с контекстом
	КонтекстID = МенеджерСущностей.НачатьТранзакцию();
	
	Автор1 = Новый Автор;
	Автор1.Имя = "Новый";
	Автор1.ВтороеИмя = "API";
	МенеджерСущностей.Сохранить(Автор1, КонтекстID);
	
	// Старый API без контекста (параллельно)
	МенеджерСущностей.НачатьТранзакцию();
	
	Автор2 = Новый Автор;
	Автор2.Имя = "Старый";
	Автор2.ВтороеИмя = "API";
	МенеджерСущностей.Сохранить(Автор2);
	
	// Фиксируем обе транзакции
	МенеджерСущностей.ЗафиксироватьТранзакцию(КонтекстID);
	МенеджерСущностей.ЗафиксироватьТранзакцию();
	
	// Проверяем результат
	Результат = МенеджерСущностей.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы ORDER BY Имя");
	Ожидаем.Что(Результат, "Должны быть сохранены оба автора").ИмеетДлину(2);
	Ожидаем.Что(Результат[0].Имя, "Первый автор").Равно("Новый");
	Ожидаем.Что(Результат[1].Имя, "Второй автор").Равно("Старый");
КонецПроцедуры

&Тест
Процедура СимуляцияФоновогоЗаданияСОшибкой() Экспорт
	// Имитируем ситуацию, когда фоновое задание завершается с ошибкой
	
	// Основной поток начинает транзакцию
	ОсновнойКонтекстID = МенеджерСущностей.НачатьТранзакцию();
	
	Автор1 = Новый Автор;
	Автор1.Имя = "Основной";
	Автор1.ВтороеИмя = "Поток";
	МенеджерСущностей.Сохранить(Автор1, ОсновнойКонтекстID);
	
	// Фоновое задание начинает свою транзакцию
	ФоновыйКонтекстID = МенеджерСущностей.НачатьТранзакцию();
	
	Автор2 = Новый Автор;
	Автор2.Имя = "Фоновое";
	Автор2.ВтороеИмя = "Задание";
	МенеджерСущностей.Сохранить(Автор2, ФоновыйКонтекстID);
	
	// Основной поток завершается успешно
	МенеджерСущностей.ЗафиксироватьТранзакцию(ОсновнойКонтекстID);
	
	// Фоновое задание завершается с ошибкой (откат)
	МенеджерСущностей.ОтменитьТранзакцию(ФоновыйКонтекстID);
	
	// Проверяем, что сохранился только автор из основного потока
	Результат = МенеджерСущностей.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы");
	Ожидаем.Что(Результат, "Должен остаться только автор из основного потока").ИмеетДлину(1);
	Ожидаем.Что(Результат[0].Имя, "Должен остаться правильный автор").Равно("Основной");
КонецПроцедуры

// Тест для демонстрации реальной работы с ФоновыеЗадания API
// (будет работать только при наличии поддержки фоновых заданий)
&Тест
Процедура ДемонстрацияФоновыхЗаданий() Экспорт
	// Проверяем доступность API фоновых заданий
	
	ДоступныФоновыеЗадания = Ложь;
	Попытка
		Если ТипЗнч(ФоновыеЗадания) = Тип("МенеджерФоновыхЗаданий") Тогда
			ДоступныФоновыеЗадания = Истина;
		КонецЕсли;
	Исключение
		// API фоновых заданий недоступен
	КонецПопытки;
	
	Если НЕ ДоступныФоновыеЗадания Тогда
		Сообщить("API фоновых заданий недоступен. Пропускаем тест реальных фоновых заданий.");
		Возврат;
	КонецЕсли;
	
	// Начинаем транзакцию в основном потоке
	ОсновнойКонтекстID = МенеджерСущностей.НачатьТранзакцию();
	
	Автор1 = Новый Автор;
	Автор1.Имя = "Основной";
	Автор1.ВтороеИмя = "Поток";
	МенеджерСущностей.Сохранить(Автор1, ОсновнойКонтекстID);
	
	// Запускаем реальное фоновое задание
	ПараметрыЗадания = Новый Структура;
	ПараметрыЗадания.Вставить("МенеджерСущностей", МенеджерСущностей);
	
	Попытка
		ФоновоеЗадание = ФоновыеЗадания.Выполнить("ФоновоеЗаданиеСозданияАвтора", ПараметрыЗадания);
		
		// Ждем завершения фонового задания (максимум 5 секунд)
		СчетчикОжидания = 0;
		Пока ФоновоеЗадание.Состояние = СостояниеФоновогоЗадания.Активно И СчетчикОжидания < 50 Цикл
			Приостановить(100); // 100 мс
			СчетчикОжидания = СчетчикОжидания + 1;
		КонецЦикла;
		
		// Фиксируем транзакцию основного потока
		МенеджерСущностей.ЗафиксироватьТранзакцию(ОсновнойКонтекстID);
		
		// Проверяем результат
		Результат = МенеджерСущностей.ПолучитьКоннектор().ВыполнитьЗапрос("SELECT * FROM Авторы ORDER BY Имя");
		
		Если ФоновоеЗадание.Состояние = СостояниеФоновогоЗадания.Завершено Тогда
			Ожидаем.Что(Результат, "Должны быть сохранены оба автора").ИмеетДлину(2);
			Ожидаем.Что(Результат[0].Имя, "Первый автор").Равно("Основной");
			Ожидаем.Что(Результат[1].Имя, "Второй автор").Равно("Фоновое");
		Иначе
			Сообщить("Фоновое задание не завершилось в ожидаемое время. Состояние: " + ФоновоеЗадание.Состояние);
			Ожидаем.Что(Результат, "Должен остаться только автор из основного потока").ИмеетДлину(1);
		КонецЕсли;
		
	Исключение
		Сообщить("Ошибка при запуске фонового задания: " + ОписаниеОшибки());
		// Все равно фиксируем основной поток
		МенеджерСущностей.ЗафиксироватьТранзакцию(ОсновнойКонтекстID);
	КонецПопытки;
КонецПроцедуры

// Процедура для выполнения в фоновом задании
Процедура ФоновоеЗаданиеСозданияАвтора(ПараметрыЗадания) Экспорт
	МенеджерСущностей = ПараметрыЗадания.МенеджерСущностей;
	
	// Начинаем транзакцию в фоновом задании
	КонтекстID = МенеджерСущностей.НачатьТранзакцию();
	
	Попытка
		Автор = Новый Автор;
		Автор.Имя = "Фоновое";
		Автор.ВтороеИмя = "Задание";
		МенеджерСущностей.Сохранить(Автор, КонтекстID);
		
		// Фиксируем транзакцию
		МенеджерСущностей.ЗафиксироватьТранзакцию(КонтекстID);
	Исключение
		// В случае ошибки откатываем транзакцию
		МенеджерСущностей.ОтменитьТранзакцию(КонтекстID);
		ВызватьИсключение;
	КонецПопытки;
КонецПроцедуры